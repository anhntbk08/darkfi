<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Implementation approach - how does this work?"><title>derive_adhoc::doc_implementation - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-cb6f1f67f1bcd037.css" id="mainThemeStyle"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="derive_adhoc" data-themes="" data-resource-suffix="" data-rustdoc-version="1.73.0-nightly (0bdb00d55 2023-08-15)" data-channel="nightly" data-search-js="search-6dfdfced5eff6596.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-1596385f77d47ef2.css" data-theme-dark-css="dark-0a43001d3fc2282c.css" data-theme-ayu-css="ayu-fd19013d6ce078bf.css" ><script src="../../static.files/storage-db41da1a38ea3cb8.js"></script><script defer src="../../static.files/main-0795b7d26be81095.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../static.files/light-1596385f77d47ef2.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../static.files/dark-0a43001d3fc2282c.css"><link rel="stylesheet" href="../../static.files/noscript-cffde32267a19fd6.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../derive_adhoc/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../derive_adhoc/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module doc_implementation</a></h2><div class="sidebar-elems"></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../index.html">derive_adhoc</a>::<wbr><a class="mod" href="#">doc_implementation</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../../src/derive_adhoc/lib.rs.html#29">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="implementation-approach---how-does-this-work"><a href="#implementation-approach---how-does-this-work">Implementation approach - how does this work?</a></h2>
<p><strong>You do not need to understand this in order to use derive-adhoc.</strong></p>
<p>Also, you should not rely on the details here.
They don’t form part of the public interface.</p>
<h3 id="introduction"><a href="#introduction">Introduction</a></h3>
<p>It is widely understood that proc macro invocations
cannot communicate with each other.
(Some people have tried sneaking round the back with disk files etc.
but this can break due to incremental and concurrent compilation.)</p>
<p>But, a proc macro can <em>define a <code>macro_rules</code> macro</em>.
Then, later proc macros can invoke that macro.
The expansion can even invoke further macros.
In this way, a proc macro invocation <em>can</em> communicate with
subsequent proc macro invocations.
(This trick is also used by
<a href="https://crates.io/crates/ambassador"><code>ambassador</code></a>.)</p>
<p>There is a further complication.
One macro X cannot peer into and dismantle
the expansion of another macro Y.
(This is necessary for soundness, when macros can generate <code>unsafe</code>.)
So we must sometimes define macros that apply other macros
(whose name is supplied as an argument)
to what is conceptually the first macro’s output.</p>
<h3 id="implementation-approach---truly-ad-hoc-macros"><a href="#implementation-approach---truly-ad-hoc-macros">Implementation approach - truly ad-hoc macros</a></h3><h4 id="1-deriveadhoc-proc-macro-for-saving-struct-definitions"><a href="#1-deriveadhoc-proc-macro-for-saving-struct-definitions">1. <code>#[derive(Adhoc)]</code> proc macro for saving struct definitions</a></h4>
<p>Implemented in <code>capture.rs::derive_adhoc_derive_macro</code>.</p>
<p>When applied to (e.g.) <code>pub struct StructName</code>, generates this</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code>    <span class="macro">macro_rules! </span>derive_adhoc_driver_StructName { {
        { $(<span class="macro-nonterminal">$template</span>:tt)* }
        { (<span class="macro-nonterminal">$orig_dollar</span>:tt) $(future:tt)* }
        $(<span class="macro-nonterminal">$tpassthrough</span>:tt)* 
     } =&gt; {
        <span class="macro">derive_adhoc_expand!</span>{
            { <span class="kw">pub struct </span>StructName { <span class="comment">/* original struct definition */ </span>} }
            { }
            { $(<span class="macro-nonterminal">$template</span>)* }
            { $(<span class="macro-nonterminal">$tpassthrough</span>)* }
        }
    } }</code></pre></div>
<p>(The extra <code>{ }</code> parts after the driver and template
include space for future expansion.)</p>
<p>In the <code>pub struct</code> part every <code>$</code> is replaced with <code>$orig_dollar</code>,
to use the <code>$</code> passed in at the invocation site.</p>
<h4 id="2-derive_adhoc-function-like-proc-macro-for-applying-to-a-template"><a href="#2-derive_adhoc-function-like-proc-macro-for-applying-to-a-template">2. <code>derive_adhoc!</code> function-like proc macro for applying to a template</a></h4>
<p>Implemented in <code>invocation.rs::derive_adhoc_func_macro</code>.</p>
<p>When applied like this</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code>    <span class="macro">derive_adhoc!</span>{
       StructName TOPTIONS...:
       TEMPLATE...
    }</code></pre></div>
<p>Expands to</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code>    <span class="macro">derive_adhoc_driver_StructName! </span>{
       { TEMPLATE... }
       { ($) }
       <span class="kw">crate</span>; [TOPTIONS...]
    }</code></pre></div>
<h4 id="3-function-like-proc-macro-to-do-the-actual-expansion"><a href="#3-function-like-proc-macro-to-do-the-actual-expansion">3. Function-like proc macro to do the actual expansion</a></h4>
<p>Implemented in <code>expand.rs::derive_adhoc_expand_func_macro</code>.</p>
<p>The result of expanding the above is this:</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code>    <span class="macro">derive_adhoc_expand!</span>{
        { <span class="kw">pub struct </span>StructName { <span class="comment">/* original struct definition */ </span>} }
        { }
        { TEMPLATE... }
        { <span class="kw">crate</span>; [TOPTIONS...] <span class="comment">/*no template name*/</span>; }
    }</code></pre></div>
<p><code>derive_adhoc_expand</code> parses <code>pub struct StructName</code>,
and implements a bespoke template expander,
whose template syntax resembles the expansion syntax from <code>macro_rules</code>.</p>
<p><code>crate</code> is just used as the expansion for <code>${crate}</code>.
(For an ad-hoc template, the local crate is correct.)</p>
<h3 id="implementation-approach---reusable-template-macros"><a href="#implementation-approach---reusable-template-macros">Implementation approach - reusable template macros</a></h3><h3 id="1-define_derive_adhoc-macro-for-defining-a-reuseable-template"><a href="#1-define_derive_adhoc-macro-for-defining-a-reuseable-template">1. <code>define_derive_adhoc!</code> macro for defining a reuseable template</a></h3>
<p>Implemented in <code>definition.rs::define_derive_adhoc_func_macro</code>.</p>
<p>When used like this</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code>    <span class="macro">define_derive_adhoc! </span>{
        MyMacro TOPTIONS... =
        TEMPLATE...
    }</code></pre></div>
<p>Expands to</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code>    <span class="macro">macro_rules! </span>derive_adhoc_template_Template { {
        { $(<span class="macro-nonterminal">$driver</span>:tt)* }
     $( [ $(<span class="macro-nonterminal">$aoptions</span>:tt)* ] )<span class="question-mark">?
        </span>{ $(<span class="macro-nonterminal">$future</span>:tt)* }
        $(<span class="macro-nonterminal">$dpassthrough</span>:tt)*
    } =&gt; {
        <span class="macro">derive_adhoc_expand! </span>{
            { $(<span class="macro-nonterminal">$driver</span>)* }
         $( [ $(aoptions)* ] )<span class="question-mark">?
            </span>{ $(<span class="macro-nonterminal">$dpassthrough</span>)* }
            { TEMPLATE... }
            { <span class="macro-nonterminal">$</span><span class="kw">crate</span>; [<span class="macro-nonterminal">TOPTIONS</span>...] Template; }
        }
    } }</code></pre></div>
<p>Except, every <code>$</code> in the TEMPLATE is replaced with <code>$orig_dollar</code>.
This is because a <code>macro_rules!</code> template
is not capable of generating a
literal in the expansion <code>$</code>.
(With the still-unstable
<a href="https://github.com/rust-lang/rust/issues/83527"><code>decl_macro</code></a>
feature, <code>$$</code> does this.)
The template expansion engine treats <code>$orig_dollar</code> as just a single <code>$</code>.</p>
<p>(Again, the extra <code>{ }</code> parts after the driver and template
include space for future expansion.)</p>
<h3 id="2-derive_adhoctemplate-implemented-in-deriveadhoc"><a href="#2-derive_adhoctemplate-implemented-in-deriveadhoc">2. <code>#[derive_adhoc(Template)]</code>, implemented in <code>#[derive(Adhoc)]</code></a></h3>
<p>Template reuse is also implemented in <code>capture.rs::derive_adhoc_derive_macro</code>.</p>
<p>This</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code>    <span class="attr">#[derive(Adhoc)]
    #[derive_adhoc(Template[AOPTIONS,...]</span>)]
    <span class="kw">pub struct </span>StructName { ... }</code></pre></div>
<p>Generates (in addition to the <code>derive_adhoc_driver_StructName</code> definition)</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code>    <span class="macro">derive_adhoc_template_Template! </span>{
        { <span class="attr">#[derive_adhoc(Template)] </span><span class="kw">struct </span>StructName { ... } }
        [<span class="number">1 0 </span>AOPTIONS]    <span class="comment">// but only if AOPTIONS is nonempty
        </span>{ }
    }</code></pre></div>
<p>The literal <code>$</code> is there to work around a limitation in <code>macro_rules!</code>,
see above.</p>
<h3 id="3-actual-expansion"><a href="#3-actual-expansion">3. Actual expansion</a></h3>
<p>The call to <code>derive_adhoc_template_Template!</code>
is expanded according to the <code>macro_rules!</code> definition,
resulting in a call to <code>derive_adhoc_expand</code>:</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">ⓘ</a><pre class="rust rust-example-rendered"><code>    <span class="macro">derive_adhoc_expand!</span>{
        { <span class="kw">pub struct </span>StructName { <span class="comment">/* original struct definition */ </span>} }
        [<span class="number">1 0 </span>AOPTIONS]    <span class="comment">// but only if AOPTIONS is nonempty
        </span>{ }
        { TEMPLATE... }
        { <span class="macro-nonterminal">$</span><span class="kw">crate</span>; [<span class="macro-nonterminal">TOPTIONS</span>...] Template; }
    }</code></pre></div>
</div></details></section></div></main></body></html>